---
title: "Data Analysis 3 - Pattern Discovery and Regression Analysis 2017/2018 Fall"
author:
- name: Peter Paziczki
- name: Imre Boda
- name: Balazs Zankay
date: '2017 november 22'
output:
  html_document: default
  pdf_document: default
  word_document: default
---

<style>
body {
text-align: justify}
</style>

```{r global_options, include=FALSE}
rm(list=ls())
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE)

```

```{r}
library(data.table)
library(ggplot2)
library(haven)
library(lspline)

# install.packages("arm")
library(arm)
# install.packages("readr")
library(readr)
# install.packages("lmtest")
library(lmtest)
# install.packages("splines")
library(splines)

#Reading input files
GDP <- fread('GDP_per_capita_2014-Data.csv', encoding = 'UTF-8')
Life <- fread('Life_expectancy_at_birth_2014-Data.csv', encoding = 'UTF-8')
```

# DA3 Assignment #2

## Problem2.1

Download cross-country data on life expectancy and GDP per capita. 
“GDP per capita, PPP (constant)” and “Life expectancy at birth (total)”

We have downloaded both the above mentioned indicators for 2014, storing them in two separate csv files, GDP_per_capita_2014-Data.csv and Life_expectancy_at_birth_2014-Data.csv.

1. Delete unnecessary columns and save a csv file with three columns only: country name, life expectancy and GDP per capita. Keep countries with non-missing values for life expectancy and GDP per capita. Document what you do.

```{r}
# Joining the two tables by Country name column.

# Settin the ON clause as keys of the tables:
setkey(GDP, `Country Name`)
setkey(Life, `Country Name`)
# Inner joining the two tables, DT syntax
Data_raw <- Life[GDP, nomatch=0]

# Dropping the unnecessary columns, keeping only country name, life expectancy and GDP per capita columns
Data <- Data_raw[, -c(1,2,4,6:8)]
# renaming country name, life expectancy and GDP per capita columns for easier usage
names(Data) <- c("country", "life", "GDP")

# Dropping the obsevórvations where there is no country, and dropping countries where life expectancy and/or GPD are missing
Data <- Data[country!="",]
Data <- Data[life!="..", ]
Data <- Data[GDP!="..", ]
n <- Data_raw[`Country Name` != "",.N] # number of countries in the original data set

# Both life expectancy and GDP per capita are character variables, they need to be converted into numeric variables.
Data <- Data[, lapply(.SD, as.numeric), by = country, .SDcols = c('life', 'GDP')]
# There are other ways to do it though ...
# Data$GDP <- as.numeric(as.character(Data$GDP))
# Data$life <- as.numeric(as.character(Data$life))
# Data <- Data[, GDP:=as.numeric(GDP)]

# Cleaning data
Data [, "GDP"] <- Data [, .(GDP = GDP/1000)]
# Taking the log of GDP per capita and sroting it in lnGDP column.
Data [, lnGDP := log(GDP)]
```

We have loaded both csv files and merged them by using a join like command. By using this special command we could make sure that relevant columns (Life expectancy and GDP) from the two tables were merged by matching the country name column, so the right values have been paired. The countries with missing life expectancy and/or GDP values have been dropped. We have `r Data[,.N]` countries of the `r n` left to analyze. Other unnecessary columns have also been dropped, such as Series Name, Series Code, Country Code. We have renamed the remaining columns as *country*, *life* and *GDP*, so it will be easier to type and use them. Finally we have divided GDP by 1000 and taken the logarithm of it.

Please find summary statistics of life variable below:
```{r}
summary(Data[,life])
ggplot (Data, aes(life)) + geom_histogram(binwidth = 1) + ggtitle(labs(title = "Histogram of life variable", x = "Life expectancy at birth [years]"))
Data [life == Data [,min(life)],]
Data [life == Data [,max(life)],]
```

Life expactancy is the highest in Hong Kong SAR, China, and the lowest in the Central African Republic.

Please find summary statistics of GDP variable below:
```{r}
summary(Data$GDP)
qplot(Data$GDP, geom="histogram", binwidth=6) + ggtitle(labs(title = "Histogram of GDP variable", x = "GDP per capita [1000 USD]"))
```

The GDP has a log normal like distribution with a long right tail, it is tipically a clear sign that we need to take the logarithm of the variable. GDP is the highest in Macao SAR, China, and the lowest in the Central African Republic. 

Please find summary statistics of lnGDP variable below:
```{r}
summary(Data$lnGDP)
qplot(Data$lnGDP, geom="histogram", binwidth=0.5) + ggtitle(labs(title = "Histogram of lnGDP variable", x = "logarithm of GDP per capita [1000 USD]"))
```

2. Estimate a lowess regression of life expectancy on ln gdp per capita. Estimate a linear regression of life expectancy on GDP per capita that best captures the nonlinearity you found (life expectancy on a piecewise linear spline or a polynomial in the explanatory variable). Argue for your choice. Report the coefficient estimates as well as their confidence interval, interpret and visualize the results.

We are estimating a non-parametric regression called lowess on life expectancy and GDP per capita. We took the logarithm of GDP per capita, we are interested in relative terms instead of absolute terms. Lowess non-parametric. Lowess produces a smooth curve, its advantage is that we can capture non-linear patterns. The disadvantage of lowess is thata it does not provide a formula that we could use to describe the relationship between life expectancy and GDP with an exact formual. What lowess does is that it provides an expected y value for every x values and for x values in-between resulting in a graph that we can use in qualitative analysis.

In this particular case we have log GDP per capita on the x axis and life expectancy on the y axis.

```{r}
# Estimating a lowess non-parametric regression on the data set.
ggplot(data = Data, aes(x=lnGDP, y=life)) +
  geom_point(size=1.5, colour="orange", shape=4) +
  geom_smooth(method="loess", colour="blue", se=F)+
  labs(x="GDP per capita, PPP [USD]",y="Life expectancy at birth [years]")+
  theme_bw()
```

We can see that the graph is has a positive slope in general. At the right end of the curve it gets a little flatter, but remains still positive.

```{r}
# Creating a scatterplot to have a quick look at the data we have:
ggplot(Data, aes(GDP, life)) + geom_point()

# Estimating a quadratic regression on GDP and life expectancy:
Data$GDP_sq<-Data$GDP^2
# Data$GDP_cub<-Data$GDP^3

reg1 <- lm(life ~ GDP + GDP_sq, data=Data)
summary(reg1)
Data$pred_quad<-predict(reg1)

ggplot(data = Data, aes(x=GDP, y=life)) +
  geom_point(size=1.5, colour="orange",shape=4) +
  labs(x="GDP per capita, PPP [USD]",y="Life expectancy at birth [years]")+
  geom_line(data=Data,aes(x=GDP,y=pred_quad),colour="blue")

# LEVEL-LOG REGRESSION
ggplot(data = Data, aes(x=lnGDP, y=life)) +
  geom_point(size=1.5, colour="orange") +
  geom_smooth(method="lm", colour="navy", se=F) 
reg2 <- lm(life ~ lnGDP, data=Data)
summary(reg2)

# HIGHEST INCOME COUNTRIES
Data$e2 <- resid(reg2)
highGDP <- subset(Data, GDP>60)

# PIECEWISE LINEAR SPLINE IN LEVEL-LOG REGRESSION
reg3 <- lm(life ~ lspline(lnGDP,4), data=Data)
coeftest(reg3)
Data$e3 <- resid(reg3)

ggplot(data = Data, aes(x=GDP, y=life)) +
  geom_point(size=1.5, colour="orange") +
  geom_smooth(method="lm", formula=y~bs(x, degree=1, knots=c(4)), colour="navy", se=F) 

# QUADRATIC IN LEVEL-LOG REGRESSION
Data$lnGDP_sq <- Data$lnGDP^2
reg4 <- lm(life ~ lnGDP + lnGDP_sq, data=Data)
# fitting polynom with given degree without defining additional variables. USE 'raw=TRUE' not to use orthogonal polynomial
# reg4 <- lm(life ~ poly(lnGDP,2, raw=TRUE), data=Data)
summary(reg4)
Data$e4 <- resid(reg4)
ggplot(data = Data, aes(x=lnGDP, y=life)) +
  geom_point(size=1.5, colour="orange") +
  geom_smooth(method="lm", formula=y~poly(x,2), colour="navy", se=F) 

# CUBIC IN LEVEL-LOG REGRESSION
Data$lnGDP_cu <- Data$lnGDP^3
reg5 <- lm(life ~ lnGDP + lnGDP_sq + lnGDP_cu, data=Data)
# or
# reg5 <- lm(life ~ poly(lnGDP,3,  raw=TRUE), data=Data)
summary(reg5)
Data$e5 <- resid(reg5)
ggplot(data = Data, aes(x=lnGDP, y=life)) +
  geom_point(size=1.5, colour="orange") +
  geom_smooth(method="lm", formula=y~poly(x,3), colour="navy", se=F) 

# HIGHEST INCOME COUNTRIES
highGDP <- subset(Data, GDP>60)
#highGDP$lngdppc_sq <- NULL
#highGDP$lngdppc_cu <- NULL

```

3. Estimate a weighted regression (weight=population). Compare results to what we saw in class. 

Problem 2.2

Download hotels_all_nov21.csv. Pick a city. Consider hotels and hostels. Consider all with at least 2 stars. You have 6 tasks (1p each). 
The goal of the exercise is to use information you have in your data to find a shortlist of five hotels and/or hostels that are good candidates for a good deal. You have to estimate a regression of prices (or log prices) on the other variables of your choice. You have to document your analysis and print the shortlist. 

1. Pick a set of variables. Describe all variables used in the analysis.

2. Investigate potential nonlinearity of each explanatory variable in simple regressions of the dependent variable. Decide on a parametric functional form for each.

3. Estimate a multiple regression with all explanatory variables in the functional form you specified previously.  

4. Pick two slope coefficients, interpret them, and compute and interpret their 95% CI. 

5. Describe your strategy to find the best deal. 

6. List the hotels with the smallest (most negative) residuals. List their prices and other characteristics as well. Comment on the results. 

Problem 2.3

- Pick another city.

- Estimate the model of your choice in the previous exercise (ie the exact same dependent variables, same functional form) for another city of your choice. Discuss your finding.

test
